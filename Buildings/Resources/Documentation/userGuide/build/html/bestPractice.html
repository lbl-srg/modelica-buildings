

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>2. Best Practice &#8212; Buildings Library User Guide</title>
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="_static/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="_static/bootstrap_custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom-sphinx.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="_static/lbl-icon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="3. Simulation Performance" href="performance.html" />
    <link rel="prev" title="1. Getting Started" href="gettingStarted.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default ">
    <div class="container-fluid">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html"><img src="_static/lbl-logo.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="https://simulationresearch.lbl.gov/modelica">Home</a></li>
                <li><a href="index.html">User Guide</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="gettingStarted.html">1. Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="gettingStarted.html#literature-for-users">1.1. Literature for Users</a></li>
<li class="toctree-l2"><a class="reference internal" href="gettingStarted.html#running-the-first-simulations">1.2. Running the First Simulations</a></li>
<li class="toctree-l2"><a class="reference internal" href="gettingStarted.html#software-requirements">1.3. Software Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="gettingStarted.html#literature-for-developers">1.4. Literature for Developers</a></li>
<li class="toctree-l2"><a class="reference internal" href="gettingStarted.html#references">1.5. References</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">2. Best Practice</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#organization-of-packages">2.1. Organization of packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-large-system-models">2.2. Building large system models</a></li>
<li class="toctree-l2"><a class="reference internal" href="#propagating-parameters-and-media-packages">2.3. Propagating parameters and media packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="#thermo-fluid-systems">2.4. Thermo-fluid systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="#controls">2.5. Controls</a></li>
<li class="toctree-l2"><a class="reference internal" href="#start-values-of-iteration-variables">2.6. Start values of iteration variables</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="performance.html">3. Simulation Performance</a><ul>
<li class="toctree-l2"><a class="reference internal" href="performance.html#control-input-signal-of-equipment">3.1. Control input signal of equipment</a></li>
<li class="toctree-l2"><a class="reference internal" href="performance.html#fluid-flow-systems">3.2. Fluid flow systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="performance.html#examples-for-how-to-debug-and-correct-slow-simulations">3.3. Examples for how to debug and correct slow simulations</a></li>
<li class="toctree-l2"><a class="reference internal" href="performance.html#numerical-solvers">3.4. Numerical solvers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="prePostProcessing.html">4. Pre- and Post-Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">5. Development</a><ul>
<li class="toctree-l2"><a class="reference internal" href="development.html#contributing">5.1. Contributing</a></li>
<li class="toctree-l2"><a class="reference internal" href="development.html#guidelines-for-contributions">5.2. Guidelines for contributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="development.html#style-guide">5.3. Style guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="development.html#adding-a-new-class">5.4. Adding a new class</a></li>
<li class="toctree-l2"><a class="reference internal" href="development.html#validation-and-unit-tests">5.5. Validation and unit tests</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="help.html">6. Help</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">7. Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgments.html">8. Acknowledgments</a></li>
<li class="toctree-l1"><a class="reference internal" href="disclaimer.html">9. Disclaimers</a></li>
<li class="toctree-l1"><a class="reference internal" href="legal.html">10. Copyright and License</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">2. Best Practice</a><ul>
<li><a class="reference internal" href="#organization-of-packages">2.1. Organization of packages</a></li>
<li><a class="reference internal" href="#building-large-system-models">2.2. Building large system models</a></li>
<li><a class="reference internal" href="#propagating-parameters-and-media-packages">2.3. Propagating parameters and media packages</a></li>
<li><a class="reference internal" href="#thermo-fluid-systems">2.4. Thermo-fluid systems</a><ul>
<li><a class="reference internal" href="#overdetermined-initialization-problem-and-inconsistent-equations">2.4.1. Overdetermined initialization problem and inconsistent equations</a></li>
<li><a class="reference internal" href="#modeling-of-fluid-junctions">2.4.2. Modeling of fluid junctions</a></li>
<li><a class="reference internal" href="#use-of-sensors-in-fluid-flow-systems">2.4.3. Use of sensors in fluid flow systems</a></li>
<li><a class="reference internal" href="#reference-pressure-for-incompressible-fluids-such-as-water">2.4.4. Reference pressure for incompressible fluids such as water</a></li>
<li><a class="reference internal" href="#nominal-values">2.4.5. Nominal Values</a></li>
</ul>
</li>
<li><a class="reference internal" href="#controls">2.5. Controls</a></li>
<li><a class="reference internal" href="#start-values-of-iteration-variables">2.6. Start values of iteration variables</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="gettingStarted.html" title="Previous Chapter: 1. Getting Started"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 1. Getting Started</span>
    </a>
  </li>
  <li>
    <a href="performance.html" title="Next Chapter: 3. Simulation Performance"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">3. Simulation... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

<!--
          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
-->
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <div class="section" id="best-practice">
<h1>2. Best Practice<a class="headerlink" href="#best-practice" title="Permalink to this headline">¶</a></h1>
<p>This section explains to library users best practice in creating system models.
The selected topics are based on problems that are often observed with new users of Modelica.
Experienced users of Modelica may skip this section.</p>
<div class="section" id="organization-of-packages">
<h2>2.1. Organization of packages<a class="headerlink" href="#organization-of-packages" title="Permalink to this headline">¶</a></h2>
<p>When developing models, one should distinguish between a library which contains widely applicable models,
such as the <cite>Buildings</cite> library, and an application-specific model which may be
created for a specific building and is of limited use for other applications.
It is recommended that users store application-specific models outside of the <cite>Buildings</cite> library.
This will allow users to replace the <cite>Buildings</cite> library with a new version without having to change the application-specific model.</p>
<p>The declare the dependency of your library on <code class="docutils literal notranslate"><span class="pre">Buildings</span></code> version 7.0.0, use
the declaration</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="kr">within</span><span class="p">;</span>
<span class="kr">package</span> <span class="nc">MyLibrary</span>

  <span class="kr">annotation</span> <span class="p">(</span>
    <span class="n">uses</span><span class="p">(</span>
      <span class="n">Buildings</span><span class="p">(</span>
        <span class="n">version</span><span class="o">=</span><span class="s2">&quot;7.0.0&quot;</span><span class="p">)</span>
      <span class="p">)</span>
   <span class="p">);</span>
<span class="kr">end</span> <span class="nc">MyLibrary</span><span class="p">;</span>
</pre></div>
</div>
<p>If during the course of the development of application-specific models,
some models turn out to be of interest for other applications, then they can be contributed to
the development of the <cite>Buildings</cite> library, as described in the section <a class="reference internal" href="development.html#development"><span class="std std-ref">Development</span></a>.</p>
</div>
<div class="section" id="building-large-system-models">
<h2>2.2. Building large system models<a class="headerlink" href="#building-large-system-models" title="Permalink to this headline">¶</a></h2>
<p>When creating a large system model, it is typically easier to build the system model
through the composition of subsystem models that can be tested in isolation. For example,
the package
<a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Examples_ChillerPlant_BaseClasses_Controls_Examples.html#Buildings.Examples.ChillerPlant.BaseClasses.Controls.Examples">Buildings.Examples.ChillerPlant.BaseClasses.Controls.Examples</a>
contains small test models that are used to test individual components in the large system model
<a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Examples_ChillerPlant.html#Buildings.Examples.ChillerPlant">Buildings.Examples.ChillerPlant</a>.
Creating small test models typically saves time as the proper response of controls, and the proper operation of subsystems, can be tested in isolation of complex system-interactions that are often present in large models.</p>
</div>
<div class="section" id="propagating-parameters-and-media-packages">
<h2>2.3. Propagating parameters and media packages<a class="headerlink" href="#propagating-parameters-and-media-packages" title="Permalink to this headline">¶</a></h2>
<p>Consider a model with a pump <code class="docutils literal notranslate"><span class="pre">pum</span></code> and a mass flow sensor <code class="docutils literal notranslate"><span class="pre">sen</span></code>.
Suppose that both models have a parameter <code class="docutils literal notranslate"><span class="pre">m_flow_nominal</span></code> for the nominal mass flow rate that needs to be set to the same value.
Rather than setting these parameters individually to a numeric value, it is recommended to propagate the parameter to the top-level of the model.
This allows to change the value of <code class="docutils literal notranslate"><span class="pre">m_flow_nominal</span></code> at one location, and then have the value be propagated to all models that reference it.
The effort for the additional declaration typically pays off as changes to the model are easier and more robust.</p>
<p>To propagate parameters, instead of using the declaration</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="n">Pump</span> <span class="n">pum</span><span class="p">(</span><span class="n">m_flow_nominal</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> <span class="s2">&quot;Pump&quot;</span><span class="p">;</span>
<span class="n">TemperatureSensor</span> <span class="n">sen</span><span class="p">(</span><span class="n">m_flow_nominal</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> <span class="s2">&quot;Sensor&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>use</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="n">Modelica</span><span class="o">.</span><span class="n">SIunits</span><span class="o">.</span><span class="n">MassFlowRate</span> <span class="n">m_flow_nominal</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="s2">&quot;Nominal mass flow rate&quot;</span><span class="p">;</span>
<span class="n">Pump</span> <span class="n">pum</span><span class="p">(</span><span class="n">m_flow_nominal</span><span class="o">=</span><span class="n">m_flow_nominal</span><span class="p">)</span> <span class="s2">&quot;Pump&quot;</span><span class="p">;</span>
<span class="n">TemperatureSensor</span> <span class="n">sen</span><span class="p">(</span><span class="n">m_flow_nominal</span><span class="o">=</span><span class="n">m_flow_nominal</span><span class="p">)</span> <span class="s2">&quot;Sensor&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>Propagating parameters and packages is also recommended for medium definitions.
This can be done by using the declaration</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="kr">replaceable</span> <span class="kr">package</span> <span class="nc">Medium</span> <span class="o">=</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Media</span><span class="o">.</span><span class="n">Interfaces</span><span class="o">.</span><span class="n">PartialMedium</span>
  <span class="s2">&quot;Medium model for air&quot;</span> <span class="kr">annotation</span> <span class="p">(</span><span class="n">choicesAllMatching</span><span class="o">=</span><span class="kc">true</span><span class="p">);</span>
</pre></div>
</div>
<p>Here, the optional annotation <code class="docutils literal notranslate"><span class="pre">annotation</span> <span class="pre">(choicesAllMatching=true)</span></code> is added which causes a GUI to show
a drop-down menu with all medium models that extend from <code class="docutils literal notranslate"><span class="pre">Modelica.Media.Interfaces.PartialMedium</span></code>.</p>
<p>If the above sensor requires a medium model, which is likely the case, its declaration would be</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="n">TemperatureSensor</span> <span class="n">sen</span><span class="p">(</span><span class="kr">redeclare</span> <span class="kr">package</span> <span class="nc">Medium</span> <span class="o">=</span> <span class="n">Medium</span><span class="p">,</span>
                      <span class="n">m_flow_nominal</span><span class="o">=</span><span class="n">m_flow_nominal</span><span class="p">)</span> <span class="s2">&quot;Sensor&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>At the top-level of a system-model, one would set the <code class="docutils literal notranslate"><span class="pre">Medium</span></code> package to an actual media, such as by using</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="kr">package</span> <span class="nc">Medium</span> <span class="o">=</span> <span class="n">Buildings</span><span class="o">.</span><span class="n">Media</span><span class="o">.</span><span class="n">PerfectGases</span><span class="o">.</span><span class="n">MoistAir</span> <span class="s2">&quot;Medium model&quot;</span><span class="p">;</span>
<span class="n">TemperatureSensor</span> <span class="n">sen</span><span class="p">(</span><span class="kr">redeclare</span> <span class="kr">package</span> <span class="nc">Medium</span> <span class="o">=</span> <span class="n">Medium</span><span class="p">,</span>
                      <span class="n">m_flow_nominal</span><span class="o">=</span><span class="n">m_flow_nominal</span><span class="p">)</span> <span class="s2">&quot;Sensor&quot;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="thermo-fluid-systems">
<h2>2.4. Thermo-fluid systems<a class="headerlink" href="#thermo-fluid-systems" title="Permalink to this headline">¶</a></h2>
<p>In this section, we describe best practices that are specific to the modeling of thermo-fluid systems.</p>
<div class="section" id="overdetermined-initialization-problem-and-inconsistent-equations">
<h3>2.4.1. Overdetermined initialization problem and inconsistent equations<a class="headerlink" href="#overdetermined-initialization-problem-and-inconsistent-equations" title="Permalink to this headline">¶</a></h3>
<p>We will now explain how state variables, such as temperature and pressure, can be initialized.</p>
<p>Consider a model consisting of a mass flow source <code class="docutils literal notranslate"><span class="pre">Modelica.Fluid.Sources.MassFlowSource_T</span></code>, a fluid volume <code class="docutils literal notranslate"><span class="pre">Buildings.Fluid.MixingVolumes.MixingVolume</span></code> and
a fixed boundary condition <code class="docutils literal notranslate"><span class="pre">Buildings.Fluid.Sources.Boundary_pT</span></code>,
connected in series as shown in the figure below. Note that the instance <code class="docutils literal notranslate"><span class="pre">bou</span></code>
implements an equation that sets the medium pressure at its port, i.e., the port pressure <code class="docutils literal notranslate"><span class="pre">bou.ports.p</span></code> is fixed.</p>
<div class="figure align-default" id="id9">
<a class="reference internal image-reference" href="_images/MixingVolumeInitialization.svg"><img alt="_images/MixingVolumeInitialization.svg" src="_images/MixingVolumeInitialization.svg" width="300px" /></a>
<p class="caption"><span class="caption-number">Fig. 2.1 </span><span class="caption-text">Schematic diagram of a flow source, a fluid volume, and a pressure source.</span><a class="headerlink" href="#id9" title="Permalink to this image">¶</a></p>
</div>
<p>The volume allows configuring balance equations for energy and mass in four different ways.
Let <span class="math notranslate nohighlight">\(p(\cdot)\)</span> be the pressure of the volume,
<span class="math notranslate nohighlight">\(p_0\)</span> be the parameter for the initial pressure,
<span class="math notranslate nohighlight">\(m(\cdot)\)</span> be the mass contained in the volume,
<span class="math notranslate nohighlight">\(\dot m_i(\cdot)\)</span> be the mass flow rate across the i-th fluid port of the volume,
<span class="math notranslate nohighlight">\(N \in \mathbb N\)</span> be the number of fluid ports, and
<span class="math notranslate nohighlight">\(t_0\)</span> be the initial time.
Then, the equations for the mass balance of the fluid volume can be configured as shown in the table below.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 19%" />
<col style="width: 24%" />
<col style="width: 24%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Initialization problem</p></th>
<th class="head"><p>Initialization problem</p></th>
<th class="head"><p>Equation used during time stepping</p></th>
</tr>
<tr class="row-even"><th class="head"><p><code class="docutils literal notranslate"><span class="pre">massDynamics</span></code></p></th>
<th class="head"><p>if <span class="math notranslate nohighlight">\(\rho = \rho(p)\)</span></p></th>
<th class="head"><p>if <span class="math notranslate nohighlight">\(\rho \not = \rho(p)\)</span></p></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">DynamicsFreeInitial</span></code></p></td>
<td><p>Unspecified</p></td>
<td><p>Unspecified</p></td>
<td><p><span class="math notranslate nohighlight">\(dm(t)/dt = \sum_{i=1}^N \dot m_i(t)\)</span></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">FixedInitial</span></code></p></td>
<td><p><span class="math notranslate nohighlight">\(p(t_0)=p_0\)</span></p></td>
<td><p>Unspecified</p></td>
<td><p><span class="math notranslate nohighlight">\(dm(t)/dt = \sum_{i=1}^N \dot m_i(t)\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">SteadyStateInitial</span></code></p></td>
<td><p><span class="math notranslate nohighlight">\(dp(t_0)/dt = 0\)</span></p></td>
<td><p>Unspecified</p></td>
<td><p><span class="math notranslate nohighlight">\(dm(t)/dt = \sum_{i=1}^N \dot m_i(t)\)</span></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">SteadyState</span></code></p></td>
<td><p>Unspecified</p></td>
<td><p>Unspecified</p></td>
<td><p><span class="math notranslate nohighlight">\(0 =  \sum_{i=1}^N \dot m_i(t)\)</span></p></td>
</tr>
</tbody>
</table>
<p><em>Unspecified</em> means that no equation is declared for the initial value
<span class="math notranslate nohighlight">\(p(t_0)\)</span>. In this situation, there can be two cases:</p>
<ol class="arabic simple">
<li><p>If a system model sets the pressure in the above model
<code class="docutils literal notranslate"><span class="pre">vol.p=vol.ports.p=bou.ports.p</span></code> due to the connection
between them, then
<span class="math notranslate nohighlight">\(p(t_0)\)</span> of the volume is equal to <code class="docutils literal notranslate"><span class="pre">bou.ports.p</span></code>.</p></li>
<li><p>If a system model does not set the pressure (i.e., if <code class="docutils literal notranslate"><span class="pre">vol</span></code> and <code class="docutils literal notranslate"><span class="pre">bou</span></code>
are not connected to each other), then the pressure starts
at the value <code class="docutils literal notranslate"><span class="pre">p(start=Medium.p_default)</span></code>, where <code class="docutils literal notranslate"><span class="pre">Medium</span></code> is the
name of the instance of the medium model.</p></li>
</ol>
<p>Since the model <code class="docutils literal notranslate"><span class="pre">Buildings.Fluid.Sources.Boundary_pT</span></code> fixes the pressure at its port,
the initial conditions <span class="math notranslate nohighlight">\(p(t_0)=p_0\)</span> and <span class="math notranslate nohighlight">\(dp(t_0)/dt = 0\)</span> lead to an overspecified system for the model shown above.
To avoid such situation, use different initial conditions, or add a flow resistance between the mixing volume and the pressure source.
The flow resistance introduces an equation that relates the pressure of the mixing volume and
the pressure source as a function of the mass flow rate, thereby removing the inconsistency.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The setting <code class="docutils literal notranslate"><span class="pre">FixedInitial</span></code> should be used with caution: Since the pressure dynamics is fast, this setting
can lead to very fast transients when the simulation starts. Such transients can cause numerical problems
for differential equation solvers.</p>
</div>
<p>Similarly, for the energy balance,
let <span class="math notranslate nohighlight">\(U(\cdot)\)</span> be the energy stored in the volume,
<span class="math notranslate nohighlight">\(T(\cdot)\)</span> be the temperature of the volume,
<span class="math notranslate nohighlight">\(m_i(\cdot)\)</span> be the mass flow rate that carries the specific enthalpy per unit mass
<span class="math notranslate nohighlight">\(h_i(\cdot)\)</span> across the i-th fluid connector of the volume, and let
<span class="math notranslate nohighlight">\(Q(\cdot)\)</span> be the heat flow at the heat port of the volume.
Then, the energy balance can be configured as shown in the table below.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 18%" />
<col style="width: 31%" />
<col style="width: 51%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Parameter
<code class="docutils literal notranslate"><span class="pre">energyDynamics</span></code></p></th>
<th class="head"><p>Initialization problem</p></th>
<th class="head"><p>Equation used during time stepping</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DynamicsFreeInitial</span></code></p></td>
<td><p>Unspecified</p></td>
<td><p><span class="math notranslate nohighlight">\(dU(t)/dt = \sum_{i=1}^N \dot m_i(t) \, h_i(t) + \dot Q(t)\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">FixedInitial</span></code></p></td>
<td><p><span class="math notranslate nohighlight">\(T(t_0)=T_0\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(dU(t)/dt = \sum_{i=1}^N \dot m_i(t) \, h_i(t) + \dot Q(t)\)</span></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">SteadyStateInitial</span></code></p></td>
<td><p><span class="math notranslate nohighlight">\(dT(t_0)/dt = 0\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(dU(t)/dt = \sum_{i=1}^N \dot m_i(t) \, h_i(t) + \dot Q(t)\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">SteadyState</span></code></p></td>
<td><p>Unspecified</p></td>
<td><p><span class="math notranslate nohighlight">\(0 = \sum_{i=1}^N \dot m_i(t) \, h_i(t) + \dot Q(t)\)</span></p></td>
</tr>
</tbody>
</table>
<p><em>Unspecified</em> means that no equation is declared for
<span class="math notranslate nohighlight">\(T(t_0)\)</span>. In this situation, there can be two cases:</p>
<ol class="arabic simple">
<li><p>If a system model sets the temperature (i.e. if in the model
the heat port of <code class="docutils literal notranslate"><span class="pre">vol</span></code> is connected to a fixed temperature),
then
<span class="math notranslate nohighlight">\(T(t_0)\)</span> of the volume would be equal to the temperature connected
to this port.</p></li>
<li><p>If a system model does not set the temperature, then the temperature starts
at the value <code class="docutils literal notranslate"><span class="pre">T(start=Medium.T_default)</span></code>, where <code class="docutils literal notranslate"><span class="pre">Medium</span></code> is the
medium model.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ol class="arabic simple">
<li><p>Selecting <code class="docutils literal notranslate"><span class="pre">SteadyState</span></code> for the energy balance and
<em>not</em> <code class="docutils literal notranslate"><span class="pre">SteadyState</span></code> for the mass balance
can lead to inconsistent equations. The model will check for this situation
and stop the translation with an error message.
To see why the equations are inconsistent,
consider a volume with two fluid ports
and no heat port. Then, it is possible
that <span class="math notranslate nohighlight">\(\dot m_1(t) \not = 0\)</span> and <span class="math notranslate nohighlight">\(\dot m_2(t) = 0\)</span>,
since <span class="math notranslate nohighlight">\(dm(t)/dt =  \dot m_1(t) + \dot m_2(t)\)</span>.
However, the energy balance equation is
<span class="math notranslate nohighlight">\(0 = \sum_{i=1}^2 \dot m_i(t) \, h_i(t) + \dot Q(t)\)</span>,
with <span class="math notranslate nohighlight">\(\dot Q(t) = 0\)</span> because there is no heat port.
Therefore, we obtain <span class="math notranslate nohighlight">\(0 = \dot m_1(t) \, h_1(t)\)</span>,
which is inconsistent.</p></li>
<li><p>Unlike the case with the pressure initialization, the temperature in
the model <code class="docutils literal notranslate"><span class="pre">bou</span></code> does not lead to <code class="docutils literal notranslate"><span class="pre">vol.T</span> <span class="pre">=</span> <span class="pre">bou.T</span></code> at initial time,
because physics allows the temperatures in <code class="docutils literal notranslate"><span class="pre">bou</span></code> and <code class="docutils literal notranslate"><span class="pre">vol</span></code> to
be different.</p></li>
</ol>
</div>
<p>The equations for the mass fraction dynamics (such as the
water vapor concentration),
and the trace substance dynamics (such as carbon dioxide concentration),
are similar to the energy equations.</p>
<p>Let
<span class="math notranslate nohighlight">\(X(\cdot)\)</span> be the mass of the species in the volume,
<span class="math notranslate nohighlight">\(m(t_0)\)</span> be the initial mass of the volume,
<span class="math notranslate nohighlight">\(x_0\)</span> be the user-selected species concentration in the volume,
<span class="math notranslate nohighlight">\(x_i(\cdot)\)</span> be the species concentration at the i-th fluid port, and
<span class="math notranslate nohighlight">\(\dot X(\cdot)\)</span> be the species added from the outside, for example the water vapor added by a humidifier.
Then, the substance dynamics can be configured as shown in the table below.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 18%" />
<col style="width: 31%" />
<col style="width: 51%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Parameter
<code class="docutils literal notranslate"><span class="pre">massDynamics</span></code></p></th>
<th class="head"><p>Initialization problem</p></th>
<th class="head"><p>Equation used during time stepping</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DynamicsFreeInitial</span></code></p></td>
<td><p>Unspecified</p></td>
<td><p><span class="math notranslate nohighlight">\(dX(t)/dt = \sum_{i=1}^N  \dot m_i(t) \, x_i(t) + \dot X(t)\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">FixedInitial</span></code></p></td>
<td><p><span class="math notranslate nohighlight">\(X(t_0)= m(t_0) \, x_0\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(dX(t)/dt = \sum_{i=1}^N  \dot m_i(t) \, x_i(t) + \dot X(t)\)</span></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">SteadyStateInitial</span></code></p></td>
<td><p><span class="math notranslate nohighlight">\(dX(t_0)/dt = 0\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(dX(t)/dt = \sum_{i=1}^N  \dot m_i(t) \, x_i(t) + \dot X(t)\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">SteadyState</span></code></p></td>
<td><p>Unspecified</p></td>
<td><p><span class="math notranslate nohighlight">\(0 = \sum_{i=1}^N  \dot m_i(t) \, x_i(t) + \dot X(t)\)</span></p></td>
</tr>
</tbody>
</table>
<p>The equations for the trace substance dynamics are identical to the equations for the substance dynamics, if
<span class="math notranslate nohighlight">\(X(\cdot), \, \dot X(\cdot)\)</span> and <span class="math notranslate nohighlight">\(x_i(\cdot)\)</span> are replaced with
<span class="math notranslate nohighlight">\(C(\cdot), \, \dot C(\cdot)\)</span> and <span class="math notranslate nohighlight">\(c_i(\cdot)\)</span>, where
<span class="math notranslate nohighlight">\(C(\cdot)\)</span> is the mass of the trace substances in the volume,
<span class="math notranslate nohighlight">\(c_i(\cdot)\)</span> is the trace substance concentration at the i-th fluid port and
<span class="math notranslate nohighlight">\(\dot C(\cdot)\)</span> is the trace substance mass flow rate added from the outside.
Therefore, energy, mass fraction and trace substances have identical equations and configurations.</p>
</div>
<div class="section" id="modeling-of-fluid-junctions">
<h3>2.4.2. Modeling of fluid junctions<a class="headerlink" href="#modeling-of-fluid-junctions" title="Permalink to this headline">¶</a></h3>
<p>In Modelica, connecting fluid ports as shown below leads to ideal mixing at the junction.
In some situation, such as the configuration below, connecting multiple connectors to
a fluid port represents the physical phenomena that was intended to model.</p>
<div class="figure align-default" id="id10">
<a class="reference internal image-reference" href="_images/fluidJunctionMixing.svg"><img alt="_images/fluidJunctionMixing.svg" src="_images/fluidJunctionMixing.svg" width="300px" /></a>
<p class="caption"><span class="caption-number">Fig. 2.2 </span><span class="caption-text">Connection of three components without explicitly introducing a flow junction model.</span><a class="headerlink" href="#id10" title="Permalink to this image">¶</a></p>
</div>
<p>However, in more complex flow configurations, one may want to explicitly control what branches of a piping or duct network mix.
This may be achieved by using an instance of the model
<a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Fluid_FixedResistances.html#Buildings.Fluid.FixedResistances.Junction">Junction</a>
as shown in the left figure below, which is derived from the test model
<a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Fluid_Boilers_Examples.html#Buildings.Fluid.Boilers.Examples.BoilerPolynomialClosedLoop">BoilerPolynomialClosedLoop</a></p>
<div class="figure align-default" id="id11">
<span id="fig-flu-cor-wro"></span><a class="reference internal image-reference" href="_images/fluidJunctionMixingSplitter.svg"><img alt="_images/fluidJunctionMixingSplitter.svg" src="_images/fluidJunctionMixingSplitter.svg" width="1200px" /></a>
<p class="caption"><span class="caption-number">Fig. 2.3 </span><span class="caption-text">Correct (a) and wrong (b) and (c) connection of components with use of a flow junction model.</span><a class="headerlink" href="#id11" title="Permalink to this image">¶</a></p>
</div>
<p>In <a class="reference internal" href="#fig-flu-cor-wro"><span class="std std-numref">Fig. 2.3</span></a> (a), the mixing points have been correctly defined by
use of the model
<a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Fluid_FixedResistances.html#Buildings.Fluid.FixedResistances.Junction">Junction</a>.
However, in <a class="reference internal" href="#fig-flu-cor-wro"><span class="std std-numref">Fig. 2.3</span></a> (b), all connections are made to the port of the instance <code class="docutils literal notranslate"><span class="pre">spl2</span></code>.
This results in the same configuration as is shown in <a class="reference internal" href="#fig-flu-cor-wro"><span class="std std-numref">Fig. 2.3</span></a> (c).
This is certainly not the intention of the modeler, as this causes all flows to be mixed in the port.
Consequently, the valve will received fluid at this mixing temperature rather than at the return temperature from the radiator,
e.g., the system model is wrong.</p>
<p>The overhead for the simulation of these flow junctions can be reduced by
setting the nominal pressure drop of flow junction model to zero,
which will remove the pressure drop equation.</p>
</div>
<div class="section" id="use-of-sensors-in-fluid-flow-systems">
<h3>2.4.3. Use of sensors in fluid flow systems<a class="headerlink" href="#use-of-sensors-in-fluid-flow-systems" title="Permalink to this headline">¶</a></h3>
<p>When selecting a sensor model, a distinction needs to be made whether the measured quantity depends on
the direction of the flow or not. If the quantity depends on the flow direction,
such as temperature or relative humidity, then sensors with two ports from the
<a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Fluid_Sensors.html#Buildings.Fluid.Sensors">Buildings.Fluid.Sensors</a>
library should be used. These sensors have a more efficient implementation than sensors with
one port for situations where the flow reverses its direction.
The proper use sensors is described in the
<a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Fluid_Sensors_UsersGuide.html">User’s Guide</a>
of the
<a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Fluid_Sensors.html#Buildings.Fluid.Sensors">Buildings.Fluid.Sensors</a>
package.</p>
</div>
<div class="section" id="reference-pressure-for-incompressible-fluids-such-as-water">
<span id="referencepressureincompressiblefluids"></span><h3>2.4.4. Reference pressure for incompressible fluids such as water<a class="headerlink" href="#reference-pressure-for-incompressible-fluids-such-as-water" title="Permalink to this headline">¶</a></h3>
<p>This section explains how to set a reference pressure for fluids that model
the flow as <a class="reference internal" href="glossary.html#term-incompressible-flow"><span class="xref std std-term">incompressible flow</span></a>,
such as
<a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Media_Water.html#Buildings.Media.Water">Buildings.Media.Water</a>
and
<a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Media_Antifreeze_PropyleneGlycolWater.html#Buildings.Media.Antifreeze.PropyleneGlycolWater">Buildings.Media.Antifreeze.PropyleneGlycolWater</a>.</p>
<p>Consider the flow circuit shown in <a class="reference internal" href="#fig-flow-cir"><span class="std std-numref">Fig. 2.4</span></a> that consists of a pump or fan,
a flow resistance and a volume.</p>
<div class="figure align-default" id="id12">
<span id="fig-flow-cir"></span><a class="reference internal image-reference" href="_images/flowCircuit.svg"><img alt="_images/flowCircuit.svg" src="_images/flowCircuit.svg" width="400pt" /></a>
<p class="caption"><span class="caption-number">Fig. 2.4 </span><span class="caption-text">Schematic diagram of a flow circuit without means
to set a reference pressure, or to account for
thermal expansion of the fluid.</span><a class="headerlink" href="#id12" title="Permalink to this image">¶</a></p>
</div>
<p>When this model is used with a medium model that models
<a class="reference internal" href="glossary.html#term-compressible-flow"><span class="xref std std-term">compressible flow</span></a>,
then the model is well defined because the gas medium implements
an equation that relates density to pressure.</p>
<p>However, when the medium model is changed to a model that models
<a class="reference internal" href="glossary.html#term-incompressible-flow"><span class="xref std std-term">incompressible flow</span></a>,
then there is no equation that can be used to compute the pressure.
In this situation, attempting to translate the model leads, in Dymola, to the following error message:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>The DAE has 151 scalar unknowns and 151 scalar equations.
Error: The model FlowCircuit is structurally singular.
The problem is structurally singular for the element type Real.
The number of scalar Real unknown elements are 58.
The number of scalar Real equation elements are 58.
</pre></div>
</div>
<p>Similarly, if the medium model
<a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Media_Specialized_Water_TemperatureDependentDensity.html#Buildings.Media.Specialized.Water.TemperatureDependentDensity">Buildings.Media.Specialized.Water.TemperatureDependentDensity</a>,
which models density as a function of pressure and enthalpy, is used, then
the model is well-defined, but the pressure increases the longer the pump runs.
The reason is that the pump adds heat to the water. When the water temperature
increases from <span class="math notranslate nohighlight">\(20^\circ \mathrm C\)</span> to <span class="math notranslate nohighlight">\(40^\circ \mathrm C\)</span>,
the pressure increases from <span class="math notranslate nohighlight">\(1 \, \mathrm{bars}\)</span> to <span class="math notranslate nohighlight">\(150 \, \mathrm{bars}\)</span>.</p>
<p>To avoid this singularity or increase in pressure,
use a model that imposes a pressure source and that accounts for the expansion of the fluid.
For example, use
<a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Fluid_Sources.html#Buildings.Fluid.Sources.Boundary_pT">Buildings.Fluid.Sources.Boundary_pT</a>
to form the system model shown in <a class="reference internal" href="#fig-flow-cir-wit-bou"><span class="std std-numref">Fig. 2.5</span></a>.</p>
<div class="figure align-default" id="id13">
<span id="fig-flow-cir-wit-bou"></span><a class="reference internal image-reference" href="_images/flowCircuitWithBoundary.svg"><img alt="_images/flowCircuitWithBoundary.svg" src="_images/flowCircuitWithBoundary.svg" width="400pt" /></a>
<p class="caption"><span class="caption-number">Fig. 2.5 </span><span class="caption-text">Schematic diagram of a flow circuit with a model that
provides a reference presssure.</span><a class="headerlink" href="#id13" title="Permalink to this image">¶</a></p>
</div>
<p>Alternatively, you may use
<a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Fluid_Storage.html#Buildings.Fluid.Storage.ExpansionVessel">Buildings.Fluid.Storage.ExpansionVessel</a>,
but
<a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Fluid_Sources.html#Buildings.Fluid.Sources.Boundary_pT">Buildings.Fluid.Sources.Boundary_pT</a>
usually leads to simpler equations than
<a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Fluid_Storage.html#Buildings.Fluid.Storage.ExpansionVessel">Buildings.Fluid.Storage.ExpansionVessel</a>.
Note that the medium that flows out of the fluid port of
<a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Fluid_Sources.html#Buildings.Fluid.Sources.Boundary_pT">Buildings.Fluid.Sources.Boundary_pT</a>
is at a fixed temperature, while the model
<a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Fluid_Storage.html#Buildings.Fluid.Storage.ExpansionVessel">Buildings.Fluid.Storage.ExpansionVessel</a>
conserves energy.
However, since the thermal expansion of the fluid is usually small,
this effect can be neglected in most building HVAC applications.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In each water circuit, there must be exactly on instance of
<a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Fluid_Sources.html#Buildings.Fluid.Sources.Boundary_pT">Buildings.Fluid.Sources.Boundary_pT</a>,
or instance of
<a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Fluid_Storage.html#Buildings.Fluid.Storage.ExpansionVessel">Buildings.Fluid.Storage.ExpansionVessel</a>.</p>
<p>If there is more than one such device, then there are multiple
points in the system that set the reference static pressure.
This will affect the distribution of the mass flow rate.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If Dymola fails to translate a model with the error message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span><span class="p">:</span> <span class="n">The</span> <span class="n">initialization</span> <span class="n">problem</span> <span class="ow">is</span> <span class="n">overspecified</span> <span class="k">for</span> <span class="n">variables</span>
<span class="n">of</span> <span class="n">element</span> <span class="nb">type</span> <span class="n">Real</span>
<span class="n">The</span> <span class="n">initial</span> <span class="n">equation</span>
<span class="o">...</span>
<span class="n">refers</span> <span class="n">to</span> <span class="n">variables</span><span class="p">,</span> <span class="n">which</span> <span class="n">are</span> <span class="nb">all</span> <span class="n">knowns</span><span class="o">.</span>
<span class="n">To</span> <span class="n">correct</span> <span class="n">it</span> <span class="n">you</span> <span class="n">can</span> <span class="n">remove</span> <span class="n">this</span> <span class="n">equation</span><span class="o">.</span>
</pre></div>
</div>
<p>then the initialization problem is overspecified. To avoid this, set</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="n">energyDynamics</span> <span class="o">=</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Fluid</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">Dynamics</span><span class="o">.</span><span class="n">DynamicsFreeInitial</span><span class="p">;</span>
<span class="n">massDynamics</span> <span class="o">=</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Fluid</span><span class="o">.</span><span class="n">Types</span><span class="o">.</span><span class="n">Dynamics</span><span class="o">.</span><span class="n">DynamicsFreeInitial</span><span class="p">;</span>
</pre></div>
</div>
<p>in the instances of the components that contain fluid volumes.</p>
</div>
</div>
<div class="section" id="nominal-values">
<h3>2.4.5. Nominal Values<a class="headerlink" href="#nominal-values" title="Permalink to this headline">¶</a></h3>
<p>Most components have a parameters for the nominal operating conditions.
These parameters have names that end in <code class="docutils literal notranslate"><span class="pre">_nominal</span></code> and they should be set to the values that
the component typically
has if it is operated at full load or design conditions. Depending on the model, these
parameters are used differently, and the respective model documentation or code
should be consulted for details. However, the table below shows typical use of
parameters in various model to help the user understand how they are used.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 17%" />
<col style="width: 22%" />
<col style="width: 61%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Model</p></th>
<th class="head"><p>Functionality</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">m_flow_nominal</span></code>
<code class="docutils literal notranslate"><span class="pre">dp_nominal</span></code></p></td>
<td><div class="line-block">
<div class="line">Flow resistance models.</div>
</div>
</td>
<td><p>These parameters may be used to define a point on the flow rate
versus pressure drop curve. For other mass flow rates, the pressure drop
is typically adjusted using similarity laws.
See <a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Fluid_FixedResistances.html#Buildings.Fluid.FixedResistances.PressureDrop">PressureDrop</a>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">m_flow_nominal</span></code>
<code class="docutils literal notranslate"><span class="pre">m_flow_small</span></code></p></td>
<td><div class="line-block">
<div class="line">Sensors.</div>
<div class="line">Volumes.</div>
<div class="line">Heat exchangers.</div>
</div>
</td>
<td><p>Some of these models set <code class="docutils literal notranslate"><span class="pre">m_flow_small=1E-4*abs(m_flow_nominal)</span></code>
as the default value. Then, m_flow_small is used to regularize, or
replace, equations when the mass flow rate is smaller than
<code class="docutils literal notranslate"><span class="pre">m_flow_small</span></code> in magnitude. This is needed to improve the numerical
properties of the model. The error in the results is negligible for
typical applications, because at flow rates below 0.01% from the
design flow rate, most model assumptions are not applicable
anyways, and the HVAC system is not operated in this region.
Modelica simulates in the continuous-time domain, thus
such small flow rates can occur, and therefore models are
implemented in such a way that they are numerically well-behaved
for zero or near-zero flow rates.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">tau</span></code>
<code class="docutils literal notranslate"><span class="pre">m_flow_nominal</span></code></p></td>
<td><div class="line-block">
<div class="line">Sensors.</div>
<div class="line">Volumes.</div>
<div class="line">Heat exchangers.</div>
<div class="line">Chillers.</div>
</div>
</td>
<td><p>Because Modelica simulates in the continuous-time domain, dynamic
models are in general numerically more efficient than steady-state
models. However, dynamic models require product data that are generally
not published by manufacturers. Examples include the volume of fluid
that is contained in a device, and the weight of heat exchangers.
In addition, other effects such as transport delays in pipes and heat
exchangers of a chiller are generally unknown and require detailed
geometry that is typically not available during the design stage.</p>
<p>To circumvent this problem, many models take as a parameter
the time constant <code class="docutils literal notranslate"><span class="pre">tau</span></code> and lump all its thermal mass
into a fluid volume. The time constant <code class="docutils literal notranslate"><span class="pre">tau</span></code> can be understood
as the time constant that one would observe if the input to
the component has a step change, and the mass flow rate of the
component is equal to <code class="docutils literal notranslate"><span class="pre">m_flow_nominal</span></code>. Using these two values
and the fluid density <code class="docutils literal notranslate"><span class="pre">rho</span></code>, components adjust their fluid volume
<code class="docutils literal notranslate"><span class="pre">V=m_flow_nominal</span> <span class="pre">tau/rho</span></code> because having such a volume
gives the specified time response. For most components,
engineering experience can be used to estimate a
reasonable value for <code class="docutils literal notranslate"><span class="pre">tau</span></code>, and where generally applicable values
can be used, components already set a default value for <code class="docutils literal notranslate"><span class="pre">tau.</span></code>
See for example <a class="reference external" href="https://simulationresearch.lbl.gov/modelica/releases/v8.0.0/help/Buildings_Fluid_HeatExchangers.html#Buildings.Fluid.HeatExchangers.WetCoilDiscretized">WetCoilDiscretized</a>.</p>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="controls">
<span id="sec-bes-pra-con"></span><h2>2.5. Controls<a class="headerlink" href="#controls" title="Permalink to this headline">¶</a></h2>
<div class="figure align-default" id="id14">
<a class="reference internal image-reference" href="_images/controlHysteresis.png"><img alt="_images/controlHysteresis.png" src="_images/controlHysteresis.png" style="width: 270.0px; height: 401.0px;" /></a>
<p class="caption"><span class="caption-number">Fig. 2.6 </span><span class="caption-text">Schematic diagram of a controller that switches a coil on and off.
In the top configuration, the hysteresis avoids numerical problems
(and short-cycling) if the control input remains close to the
set point. The bottom configuration can cause the integration to
stall if the input signal to the threshold block is the solution
of an iterative solver and remains around 293.15 Kelvin.</span><a class="headerlink" href="#id14" title="Permalink to this image">¶</a></p>
</div>
<p>When implementing an on/off controller, always use a controller with
hysteresis such as shown in the top configuration of the model above.
If no hysteresis is used, then numerical problems can occur if the
variable that is input to the controller depends on a variable
that is computed by an iterative algorithm.
Examples of a iterative algorithms are nonlinear equation solvers
or time integration algorithms with variable step size (such as
the radau and dassl solver in Dymola).
The problem is caused as follows:
Let <span class="math notranslate nohighlight">\(T(t) \in \Re\)</span> be the input into a controller, such as
a room air temperature.
If <span class="math notranslate nohighlight">\(T(t)\)</span> is the state variable computed by solving a differential equation,
or if <span class="math notranslate nohighlight">\(T(t)\)</span> depends on a variable that needs to be solved for iteratively,
then <span class="math notranslate nohighlight">\(T(t)\)</span> can only be approximated by some approximation
<span class="math notranslate nohighlight">\(T^*(\epsilon, t)\)</span>, where
<span class="math notranslate nohighlight">\(\epsilon\)</span> is the solver tolerance. Even if the system is at
an equilibrium, the solver can cause the value of <span class="math notranslate nohighlight">\(T^*(\epsilon, t)\)</span>
to slightly change from one iteration to another. Hence,
<span class="math notranslate nohighlight">\(T^*(\epsilon, t)\)</span> can exhibit what is called numerical noise.
Now, if <span class="math notranslate nohighlight">\(T^*(\epsilon, t)\)</span> is used to switch a heater on and off
whenever it crosses at set point temperature, and if
<span class="math notranslate nohighlight">\(T(t)\)</span> happens to be at an equilibrium near the set point temperature,
then the heater can switch on and off rapidly due to the numerical noise.
This can cause the time integration to stall.</p>
<p>To illustrate this problem, try to simulate</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="kr">model</span> <span class="nc">Unstable</span>
  <span class="nb">Real</span> <span class="n">x</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.1</span><span class="p">);</span>
<span class="kr">equation</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="kr">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="kr">then</span> <span class="o">-</span><span class="mi">1</span> <span class="kr">else</span> <span class="mi">1</span><span class="p">;</span>
<span class="kr">end</span> <span class="nc">Unstable</span><span class="p">;</span>
</pre></div>
</div>
<p>In Dymola 2013, as expected the model stalls at <span class="math notranslate nohighlight">\(t=0.1\)</span>
because the <code class="docutils literal notranslate"><span class="pre">if-then-else</span></code> construct triggers an event iteration whenever
<span class="math notranslate nohighlight">\(x\)</span> crosses zero.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Never use an inequality comparison without a
hysteresis or a time delay if the variable that is used in the
inequality test</p>
<ul class="simple">
<li><p>is computed using an <a class="reference internal" href="glossary.html#term-iterative-solver"><span class="xref std std-term">iterative solver</span></a>, or</p></li>
<li><p>is obtained from a measurement and hence can contain measurement
noise.</p></li>
</ul>
<p>An exception is a sampled value because the output of a sampler remains constant
until the next sampling instant.</p>
<p>See <a class="reference internal" href="performance.html#sec-example-event-debugging"><span class="std std-ref">Examples for how to debug and correct slow simulations</span></a> for what can happen in
such tests.</p>
</div>
</div>
<div class="section" id="start-values-of-iteration-variables">
<h2>2.6. Start values of iteration variables<a class="headerlink" href="#start-values-of-iteration-variables" title="Permalink to this headline">¶</a></h2>
<p>When computing numerical solutions to systems of nonlinear equations, a Newton-based solver
is typically used. Such solvers have a higher success of convergence
if good start values are provided for the iteration variables. In Dymola,
to see what start values are used, one can enter on the simulation tab the command</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Advanced.LogStartValuesForIterationVariables = true;
</pre></div>
</div>
<p>Then, when a model is translated, for example using</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>translateModel(&quot;Buildings.Fluid.Boilers.Examples.BoilerPolynomialClosedLoop&quot;);
</pre></div>
</div>
<p>an output of the form</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Start values for iteration variables:
 val.res1.dp(start = 3000.0)
 val.res3.dp(start = 3000.0)
</pre></div>
</div>
<p>is produced. This shows the iteration variables and their start values.
These start values can be overwritten in the model.</p>
</div>
</div>


    </div>
      
  </div>
</div>
  
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2012-2020, The Regents of the University of California (through Lawrence Berkeley National Laboratory).<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.1.2.<br/>
    </p>
  </div>
</footer>

  </body>
</html>